---
import '../styles/reader.scss';
---
<script is:inline src="/ndarray.js"></script>
<script is:inline src="/nifti-reader.js"></script>
<script is:inline src="/local-reader.js"> </script>

<div class="niftireader">
    <input type="file" id="file" name="files" />
    <div class="controllers">
        <div class="controller" id="controller-plan">
            <h3>Plan</h3>
            <div class="control-body">
                <input type="radio" id="axiale" name="selecoupe" value="axiale" checked>
                <label for="axiale">Axial</label>
                <input type="radio" id="sagittale" name="selecoupe" value="sagittale">
                <label for="sagittale">Sagittal</label>
                <input type="radio" id="coronale" name="selecoupe" value="coronale">
                <label for="coronale">Coronal</label>
            </div>
        </div>
        <div class="controller">
            <h3>Position</h3>
            <div class="control-body">
                <label for="niftislider" class="labelslider" id="slider-progress">50%</label>
                <input id="niftislider" class="niftislider" type="range" min="1" max="100" value="50" class="slider" >
            </div>
        </div>
        <div class="controller">
            <h3>Opacit√©</h3>
            <div class="control-body">
                <label for="opacityslider" class="labelslider" id="opacity-progress">50%</label>
                <input id="opacityslider" class="niftislider" type="range" min="1" max="100" value="50" class="slider" >
            </div>
        </div>
    </div>
    <canvas id="nifticanvas" class="nifticanvas" ></canvas>
    <div id="legend"></div>
    <div id="filenames"></div>
</div>

<script type="text/javascript">
let currentfiles = [];
let id_current = -1;
function displayCurrentFile(){
    displaySpecificFile(id_current);
}
function displaySpecificFile(id){
    let f = currentfiles[id];
    handleFileSelect([f],'nifticanvas','niftislider',getCoupe());
}

function addNewFile(f){
    currentfiles.push(f);
    id_current = currentfiles.length-1;
}
document.getElementById('file').addEventListener('change', (evt)=> {
    let f = evt.target.files[0];
    addNewFile(f)
    displayCurrentFile();
    displayFileNames();
}, false);

function displayFileNames(){
    let filenameControl = "";
    for(let i in currentfiles){
        let file = currentfiles[i];
        filenameControl += "<div class=filename id=file"+i+">";
        filenameControl+=  file.name;
        filenameControl+='<'+'/'+"div>"; 
    }
    let filenamesEl =  document.getElementById('filenames');
    filenamesEl.innerHTML = filenameControl;
    for(let filename of filenamesEl.getElementsByClassName('filename')){
        filename.addEventListener('click',(evt)=>{
            let id = +evt.target.id.replace("file","");
            id_current = id;
            displayCurrentFile();
            updateIdCurrentFile();
        })
    }
    updateIdCurrentFile();
}
function updateIdCurrentFile(){
   for(let el of document.getElementsByClassName('filename')){
    el.setAttribute('class','filename');
   }
   document.getElementById('file'+id_current).setAttribute('class','filename current-filename');
}

document.getElementById('niftislider').addEventListener("input", (event) => {
  document.getElementById('slider-progress').textContent = event.target.value +"%"
})

updateCurrentCoupe();

function resetLoadedCanvas(){
    resetCanvas('nifticanvas','niftislider');
    currentfiles = [];
}
function getCoupe(){
    let coupe = "axiale";
    if(document.getElementById("sagittale").checked)coupe = "sagittale";
    else if(document.getElementById("coronale").checked)coupe = "coronale";
    return coupe;
}
function updateCurrentCoupe(){
    let coupes = document.getElementsByName("selecoupe");
    for(let selecoupe of coupes){
        selecoupe.addEventListener('change',(evt)=> {   
            displayCurrentFile(id_current);
        })
    }
}
getCoupe();
</script>