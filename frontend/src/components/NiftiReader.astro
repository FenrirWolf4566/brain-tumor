---
import '../styles/reader.scss';
---
<script is:inline src="/ndarray.js"></script>
<script is:inline src="/nifti-reader.js"></script>
<script is:inline src="/local-reader.js"> </script>
<div class="niftireader">
    <input type="file" id="file" name="files" />
    <div class="controllers">
        <div class="controller" id="controller-plan">
            <h3>Plan</h3>
            <div class="control-body">
                <input type="radio" id="axiale" name="selecoupe" value="axiale" checked>
                <label for="axiale">Axial</label>
                <input type="radio" id="sagittale" name="selecoupe" value="sagittale">
                <label for="sagittale">Sagittal</label>
                <input type="radio" id="coronale" name="selecoupe" value="coronale">
                <label for="coronale">Coronal</label>
            </div>
        </div>
        <div class="controller">
            <h3>Position</h3>
            <div class="control-body">
                <label for="niftislider" class="labelslider" id="slider-progress">50%</label>
                <input id="niftislider" class="niftislider" type="range" min="1" max="100" value="50" class="slider" >
            </div>
        </div>
        <div class="controller">
            <h3>Opacité</h3>
            <div class="control-body">
                <label for="opacityslider" class="labelslider" id="opacity-progress">50%</label>
                <input id="opacityslider" class="niftislider" type="range" min="1" max="100" value="50" class="slider" >
            </div>
        </div>
    </div>
    <canvas id="nifticanvas" class="nifticanvas" ></canvas>
    <div id="legend"></div>
    <div id="filenames"></div>
</div>

<script type="text/javascript">
let currentfiles = [];
let id_current = -1;
function displayCurrentFile(){
    displaySpecificFile(id_current);
}
function displaySpecificFile(id){
    let f = currentfiles[id];
    if(id>=0 && id<currentfiles.length) handleFileSelect([f],'nifticanvas','niftislider',getCoupe(),true);
    else resetLoadedCanvas();
}

function addNewFile(f){
    if(f.name.endsWith(".nii")|| f.name.endsWith('.nii.gz')){
        currentfiles.push(f);
        id_current = currentfiles.length-1;
        return true;
    }
    return false;
}
document.getElementById('file').addEventListener('change', (evt)=> {
    let f = evt.target.files[0];
    if(addNewFile(f)){
        displayCurrentFile();
        displayFileNames();
    }
});

//N1 : nb de char a debut
//N2 : nb de char à la fin
const shortenString = (s, N1, N2) => s.length > N1 + N2 + 3 ? `${s.slice(0, N1)}...${s.slice(-N2)}` : s;

function displayFileNames(){
    let filenameControl = "";
    for(let i in currentfiles){
        let file = currentfiles[i]; 
        let name = shortenString(file.name,7,12);
        filenameControl += `<div class=filename id=file${i} title=${file.name}>`;
        let id='('+i+')'
        filenameControl+=  `<span>${name}</span>`;
        filenameControl += `<button onclick=deleteFile${id}>[X]</button>`;
        filenameControl+='<'+'/'+"div>"; 
    }
    let filenamesEl =  document.getElementById('filenames');
    filenamesEl.innerHTML = filenameControl;
    for(let filename of filenamesEl.getElementsByClassName('filename')){
        filename.children[0].addEventListener('click',(evt)=>{
            let id = +filename.id.replace("file","");
            id_current = id;
            displayCurrentFile();
            updateIdCurrentFile();
        })
    }   
    updateIdCurrentFile();
}

function deleteFile(idFile){
    currentfiles.splice(idFile, 1);
    if(id_current>=idFile)id_current--;
    displayFileNames();
    displayCurrentFile();
}

// for graphical purposes, we want to identify which file is the current
function updateIdCurrentFile(){
   for(let el of document.getElementsByClassName('filename')){
    el.setAttribute('class','filename');
   }
   if(id_current!=-1) document.getElementById('file'+id_current).setAttribute('class','filename current-filename');
}

document.getElementById('niftislider').addEventListener("input", (event) => {
  document.getElementById('slider-progress').textContent = event.target.value +"%"
})

function resetLoadedCanvas(){
    resetCanvas('nifticanvas','niftislider');
    currentfiles = [];
}
function getCoupe(){
    let coupe = "axiale";
    if(document.getElementById("sagittale").checked)coupe = "sagittale";
    else if(document.getElementById("coronale").checked)coupe = "coronale";
    return coupe;
}
function updateCurrentCoupe(){
    let coupes = document.getElementsByName("selecoupe");
    for(let selecoupe of coupes){
        selecoupe.addEventListener('change',(evt)=> {   
            displayCurrentFile(id_current);
        })
    }
}
updateCurrentCoupe();
getCoupe();
</script>